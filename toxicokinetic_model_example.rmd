---
title: "The three perspectives demonstrated on a toy example"
author: "Sandrine Charles, Roman Ashauer, Andreas Scheidegger"
date: "August 11, 2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=9)
knitr::opts_chunk$set(warning = FALSE)
library(ggplot2)
library(maxLik)            # maximum likelihood estimation
library(adaptMCMC)         # MCMC sampling algorithm
```

## Introduction

This document provides an analysis using a one-compartment toxicokinetic model. The dataset used comes from *Gammarus pulex* exposed to Malathion, as reported by Ashauer (2010). The analysis explores three different perspectives: using pre-defined parameters, performing maximum likelihood estimation (MLE), and incorporating Bayesian approaches to account for parameter uncertainty.

## Notes

- The dataset used is from Ashauer 2010. The 'sampling_date' column does not directly correspond to 'replicate' in another dataset by Sandrine, but it will be treated as a factor here.
- We use Limit of Quantification divided by 2 for below-detection data, which is a common but not entirely correct approach.
- The priors are based on Hendriks et al. (2001), which are relevant to the parameters of the toxicokinetic model.

## Helper Function

This function computes the 5%, 50%, and 95% intervals over time, based on Monte Carlo simulations of the model output. These intervals help us understand the range of possible outcomes from the model.

```{r}
compute.intervals <- function(X, tsim){
    intervals <-  t(apply(X, 2, function(x){quantile(x, probs=c(0.05, 0.5, 0.95))}))
    intervals <- as.data.frame(intervals)
    colnames(intervals) <- c("p05", "p50", "p95")
    intervals$time <- tsim
    intervals
}
```

## Import Data

Here, we load the dataset which contains measurements of internal concentrations in *Gammarus pulex* over time. The dataset is then visualized to understand the time course of internal concentration.

```{r}
df <- read.table("data/data_Malathion_Ashauer_2010.csv", header = TRUE, sep = ",")
df$sampling_date <- as.factor(df$sampling_date)

ggplot(data = df, aes(x = time, y = Cinternal, col=sampling_date)) +
    geom_line() +
    geom_point(size=5) +
    xlab("Time (days)") +
    ylab("Internal measured concentration (picomol/g wet weight)") +
    geom_vline(xintercept = 1, linetype="dashed")
```

We also define the limit of quantification (LOQ)
```{r}
## Limit of detection nmol/kg(wet weight)
## from Table 5 in SI of Ashaue et al (2010)
LOQ <- 6

```
## Define Deterministic Model

We define a deterministic toxicokinetic model with two parameters: uptake rate ($k_u$) and elimination rate ($k_e$). This model predicts the internal concentration based on the exposure concentration in water and the simulation times.

```{r}
bioacc <- function(parameters, C_water, tc, tsim){
    k.u <- parameters[1]
    k.e <- parameters[2]

    tacc <- tsim[tsim <= tc]
    Cacc <- k.u*C_water*(1 - exp(-k.e*tacc))/k.e

    tdep <- tsim[tsim > tc]
    Cdep <- k.u*C_water*(exp(k.e*(tc - tdep)) - exp(-k.e*tdep))/k.e

    result <- data.frame(time = c(tacc, tdep),
                         conc = c(Cacc, Cdep))
    return(result)
}
```

## Perspective 1: Pre-defined Parameters

Using pre-defined parameters based on Hendriks et al. (2001), we run the model to predict internal concentrations and compare them to the observed data. We also sample parameter uncertainty and plot the 90% prediction interval.

```{r}
parameters.P1 <- c(k.u = 112.798, k.e = 0.00296)
C_water <- unique(df$Cwater)
tc <- 1
tsim <- seq(0, 7.5, length=111)

simu.mean <- bioacc(parameters.P1, C_water, tc, tsim)

ggplot(simu.mean, aes(time, conc)) +
    geom_line(col = "orange", linewidth = 1.5) +
    xlab("Time (hours)") +
    ylab("Internal predicted concentrations") +
    geom_vline(xintercept = 1, linetype="dashed") +
    geom_point(data = df, aes(time, Cinternal)) +
    ggtitle("Perspective 1")

n <- 10000
X.para <- matrix(NA, ncol=length(tsim), nrow=n)
for(i in 1:n){
    para <- c(10^(rnorm(1, log10(parameters.P1[1]), 1)),
              10^(rnorm(1, log10(parameters.P1[2]), 1)))
    X.para[i,] <- bioacc(para, C_water, tc, tsim)$conc
}

intervals.para <- compute.intervals(X.para, tsim)

ggplot(intervals.para) +
    geom_line(aes(x=time, y=p50), col = "orange", linewidth = 1.5) +
    geom_ribbon(aes(x=time, y=p50, ymin=p05, ymax=p95), alpha = 0.2) +
    xlab("Time (hours)") +
    ylab("Internal concentration") +
    geom_vline(xintercept = 1, linetype="dashed") +
    geom_point(data = df, aes(time, Cinternal)) +
    ggtitle("Perspective 1 - 90% parameter uncertainty interval")
```

## Perspective 2: Maximum Likelihood Estimation (MLE)

We estimate the parameters by maximizing the likelihood of the observed data, assuming normal and gamma-distributed errors. We then fit the model using these MLE parameters.

```{r}
log.ll.normal <- function(theta, data, LOQ=6) {
    conc.pred <- bioacc(theta, unique(data$Cwater), tc = 1, tsim = data$time)$conc
    obs <- ifelse(data$Cinternal==0, LOQ/2, data$Cinternal)
    sum(dnorm(obs, mean=conc.pred, sd=exp(theta[3]), log=TRUE))
}

mle = maxLik(log.ll.normal, start=c(k.u=90, k.e=1, log.sd=log(1)), data=df, LOQ = LOQ)
summary(mle)

parameters.P2 <- mle$estimate
simu.mean <- bioacc(parameters.P2, C_water, tc, tsim)

ggplot(simu.mean, aes(time, conc)) +
    geom_line(col = "orange", linewidth = 1.5) +
    xlab("Time (hours)") +
    ylab("Internal predicted concentrations") +
    geom_vline(xintercept = 1, linetype="dashed") +
    geom_point(data = df, aes(time, Cinternal)) +
    ggtitle("MLE fit for normal errors")
```

We repeat the above process for gamma-distributed errors.

```{r}
log.ll.gamma <- function(theta, data, LOQ=6) {
    mode <- bioacc(theta, unique(data$Cwater), tc = 1, tsim = data$time)$conc
    sd <- exp(theta[3])
    scale <- 0.5*(sqrt(4*sd^2+mode^2) - mode)
    shape <- mode/scale + 1
    obs <- ifelse(data$Cinternal==0, LOQ/2, data$Cinternal)
    sum(dgamma(obs, shape=shape, scale=scale, log=TRUE))
}

mle = maxLik(log.ll.gamma, start=c(k.u=80, k.e=0.8, log.sd=log(1)), data=df, LOQ=LOQ, method="BFGS")
summary(mle)

parameters.P2 <- mle$estimate
simu.mean <- bioacc(parameters.P2, C_water, tc, tsim)

ggplot(simu.mean, aes(time, conc)) +
    geom_line(col = "orange", linewidth = 1.5) +
    xlab("Time (hours)") +
    ylab("Internal predicted concentrations") +
    geom_vline(xintercept = 1, linetype="dashed") +
    geom_point(data = df, aes(time, Cinternal)) +
    ggtitle("MLE fit for gamma errors")
```

## Perspective 3: Bayesian Inference

We incorporate prior knowledge into the model using a Bayesian approach, which allows us to sample from the posterior distribution of the parameters and estimate the uncertainty in our predictions.

### Log-Prior Definition

The priors for the parameters are based on Hendriks et al. (2001).

```{r}
log.prior <- function(theta) {
    k.u <- 112.798
    k.e <- 0.00296

    meanlog.k.u = log10(k.u) / log10(exp(1))
    meanlog.k.e = log10(k.e) / log10(exp(1))
    sdlog = log10(10) / log10(exp(1))

    dlnorm(theta[1], meanlog.k.u, sdlog, log=TRUE) +
        dlnorm(theta[2], meanlog.k.e, sdlog, log=TRUE) +
        dnorm(theta[3], 2, 2, log=TRUE)
}
```

### Posterior Distribution

We define functions proportional to the posterior distribution, incorporating both likelihood and prior information.

```{r}
log.post.normal <- function(theta, data, ...) {
    log.ll.normal(theta, data, ...) + log.prior(theta)
}

log.post.gamma <- function(theta, data, ...) {
    log.ll.gamma(theta, data, ...) + log.prior(theta)
}
```

### MCMC Sampling

We sample from the posterior distribution using a Markov Chain Monte Carlo (MCMC) method. This helps us quantify the uncertainty in the model predictions.

```{r}
pp.normal <- MCMC(log.post.normal, n=15000,
                  init = c(k.u=90, k.e=1, log.sd=2),
                  scale = c(100, 1, 1), acc.rate=0.2,
                  showProgressBar = FALSE,
                  data=df, LOQ = LOQ)
post.normal <- convert.to.coda(pp.normal)

plot(post.normal)                              # whole chain

plot(window(post.normal, start=5000))

pairs(pp.normal$samples, col=gray(0, alpha=0.01))

pp.gamma <- MCMC(log.post.gamma, n=15000,
                 init = c(k.u=90, k.e=1, log.sd=2),
                 scale = c(100, 1, 1),
                 showProgressBar = FALSE,
                 data=df, acc.rate=0.2)
post.gamma <- convert.to.coda(pp.gamma)

plot(post.gamma)                              # whole chain

plot(window(post.gamma, start=5000))

pairs(pp.gamma$samples, col=gray(0, alpha=0.01))
```

### Credibility Intervals

Finally, we plot the 90% credibility intervals for normal and gamma errors, incorporating both parameter and total uncertainty.

```{r}
n <- 10000
X.para <- X.total <- matrix(NA, ncol=length(tsim), nrow=n)
for(i in 1:n){
    idx <- sample(1:nrow(pp.normal$samples),1)
    para <- pp.normal$samples[idx,]
    X.para[i,] <- bioacc(para, C_water, tc, tsim)$conc
    sd <- exp(para[3])
    X.total[i,] <- rnorm(length(tsim), mean=X.para[i,], sd=sd)
}

intervals.para <- compute.intervals(X.para, tsim)
intervals.total <- compute.intervals(X.total, tsim)

ggplot(intervals.para) +
    geom_line(aes(x=time, y=p50), col = "orange", linewidth = 1.5) +
    geom_ribbon(aes(x=time, y=p50, ymin=p05, ymax=p95), alpha = 0.2) +
    geom_ribbon(data=intervals.total, aes(x=time, y=p50, ymin=p05, ymax=p95), alpha = 0.2) +
    xlab("Time (hours)") +
    ylab("Internal concentration") +
    geom_vline(xintercept = 1, linetype="dashed") +
    geom_point(data = df, aes(time, Cinternal)) +
    ggtitle("90% parameter and total uncertainty interval with normal errors")

n <- 10000
X.para <- X.total <- matrix(NA, ncol=length(tsim), nrow=n)
for(i in 1:n){
    idx <- sample(1:nrow(pp.gamma$samples),1)
    para <- pp.gamma$samples[idx,]
    X.para[i,] <- mode <- bioacc(para, C_water, tc, tsim)$conc
    sd <- exp(para[3])
    scale <- 0.5*(sqrt(4*sd^2+mode^2) - mode)
    shape <- mode/scale + 1
    X.total[i,] <- rgamma(length(tsim), scale=scale, shape=shape)
}

intervals.para <- compute.intervals(X.para, tsim)
intervals.total <- compute.intervals(X.total, tsim)

ggplot(intervals.para) +
    geom_line(aes(x=time, y=p50), col = "orange", linewidth = 1.5) +
    geom_ribbon(aes(x=time, y=p50, ymin=p05, ymax=p95), alpha = 0.2) +
    geom_ribbon(data=intervals.total, aes(x=time, y=p50, ymin=p05, ymax=p95), alpha = 0.2) +
    xlab("Time (hours)") +
    ylab("Internal concentration") +
    geom_vline(xintercept = 1, linetype="dashed") +
    geom_point(data = df, aes(time, Cinternal)) +
    ggtitle("90% parameter and total uncertainty interval with gamma errors")
```
